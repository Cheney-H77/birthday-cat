<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <meta property="og:title" content="ç”Ÿæ—¥å½©è›‹">
  <meta property="og:description" content="é•¿æŒ‰ 2 ç§’è§£é”è½¬ç›˜ï¼Œå°å¿ƒæœ‰æƒŠå–œ">
  <title>ç”Ÿæ—¥å½©è›‹</title>
  <style>
    :root{ --milk:#fff9f3; --tea:#222; --gray:#7a7a7a; --gold:#d4b073; --pink:#ff5c8a; --radius:20px; --shadow:0 10px 22px rgba(0,0,0,.08) }
    html,body{margin:0;background:var(--milk);color:var(--tea);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
    h1{font-size:26px;font-weight:800;text-align:center;margin:18px 0}
    .wrap{max-width:1000px;margin:0 auto;padding:12px 16px 48px}
    .row{display:grid;grid-template-columns:1fr 300px;gap:18px;align-items:start}

    /* è§£é”ç¯ */
    .locker{display:flex;justify-content:center;margin:8px 0 16px}
    .ring{width:180px;height:180px;border-radius:50%;border:6px solid rgba(212,176,115,.6);position:relative;display:flex;align-items:center;justify-content:center;user-select:none;touch-action:none;box-shadow:var(--shadow);background:#fff}
    .ring .fill{position:absolute;inset:0;border-radius:50%;mask:radial-gradient(circle at 50% 50%, transparent 65px, black 66px);background:conic-gradient(var(--pink) 0deg, var(--pink) 0deg, transparent 0deg)}
    .ring p{z-index:1;color:#7a7a7a}

    /* è½¬ç›˜ */
    .board{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:14px;align-items:center}
    #wheel{position:relative;width:360px;height:360px;border-radius:50%;border:10px solid #f0e5d2;overflow:hidden;transition:transform 4s cubic-bezier(.17,.89,.32,1.27)}
    .sector{position:absolute;left:50%;top:50%;width:50%;height:50%;transform-origin:0 100%}
    .label{position:absolute;left:68%;top:42%;transform:translate(-50%,-50%) rotate(0);width:120px;text-align:center;font-weight:700;font-size:14px}
    .pin{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid var(--pink);margin-top:-6px}

    .panel{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .panel h3{margin:0 0 8px}
    .muted{color:#7a7a7a}

    .btn{appearance:none;border:0;border-radius:999px;background:linear-gradient(180deg,#ffd6e3,#ffb2c8);color:#7a2141;padding:10px 16px;font-weight:800;box-shadow:var(--shadow);cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    /* å¼¹å±‚ */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center}
    .overlay.show{display:flex}
    .dialog{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px;max-width:360px;text-align:center}
    .dialog img{width:100%;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ å½©è›‹</h1>

    <div class="locker">
      <div id="ring" class="ring" aria-label="é•¿æŒ‰ 2 ç§’è§£é”">
        <div id="ringFill" class="fill"></div>
        <p id="ringText">é•¿æŒ‰ 2 ç§’è§£é”</p>
      </div>
    </div>

    <div class="row" id="main" style="display:none">
      <div class="board">
        <div class="pin"></div>
        <div id="wheel" aria-label="å¹¸è¿è½¬ç›˜"></div>
        <div>
          <button id="spinBtn" class="btn">è½¬ä¸€ä¸‹ï¼</button>
        </div>
        <div class="muted" id="chanceText">å‰©ä½™æ¬¡æ•°ï¼š2</div>
      </div>
      <div class="panel">
        <h3>æŠ½ä¸­ç»“æœ</h3>
        <div id="prizeNow" class="muted">å°šæœªæŠ½å–</div>
      </div>
    </div>
  </div>

  <!-- å…”å­/å°ç©ä¼´å¼¹å±‚ -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>ç»™ç³–è±†æ‰¾ä¸€ä¸ªå°ç©ä¼´</h3>
      <img src="../assets/rabbit.jpg" alt="å°ç©ä¼´">
      <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
        <button class="btn" id="saveCard">ä¿å­˜è¿™å¼ å¡ç‰‡</button>
        <button class="btn" id="closeModal" style="background:#e9d6b3;color:#6b5835">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
  ;const Storage={get(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){return f}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}};

  // ========== 1) é•¿æŒ‰è§£é” ========== //
  ;(function Locker(){
    const ring=document.getElementById('ring'), fill=document.getElementById('ringFill'), text=document.getElementById('ringText');
    let timer=null, t=0;
    function setProg(p){ // p:0~1
      const deg=Math.floor(p*360); fill.style.background=`conic-gradient(var(--pink) ${deg}deg, transparent ${deg}deg)`; text.textContent=p>=1?'è§£é”æˆåŠŸï¼':'é•¿æŒ‰ 2 ç§’è§£é”';
    }
    function start(){ if(timer) return; const startAt=Date.now(); timer=setInterval(()=>{ t=(Date.now()-startAt)/2000; setProg(t); if(t>=1){ clearInterval(timer); timer=null; unlock(); } },60); }
    function end(){ if(!timer) return; clearInterval(timer); timer=null; t=0; setProg(0); }
    function unlock(){
      navigator.vibrate?.(30);
      Storage.set('bc_locker_unlocked',true);
      document.getElementById('main').style.display='grid';
      ring.style.opacity=.4; text.textContent='å·²è§£é”';
    }
    if(Storage.get('bc_locker_unlocked',false)) { setProg(1); document.getElementById('main').style.display='grid'; text.textContent='å·²è§£é”'; ring.style.opacity=.4; }
    ring.addEventListener('mousedown',start); ring.addEventListener('touchstart',start,{passive:true});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(e=>ring.addEventListener(e,end));
  })();

  // ========== 2) å¥–æ±  & è½¬ç›˜ ========== //
  ;const PrizePanel=(function(){
    const el=document.getElementById('prizeNow');
    return { set(txt){ el.textContent=txt; } }
  })();

  ;const SaveCard=(function(){
    async function save(){
      const cvs=document.createElement('canvas'); const W=720,H=1080; cvs.width=W; cvs.height=H; const ctx=cvs.getContext('2d');
      // èƒŒæ™¯æ¸å˜
      const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#fff1f6'); g.addColorStop(1,'#ffe7d2'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
      // æ ‡é¢˜
      ctx.fillStyle='#7a2141'; ctx.font='bold 48px system-ui'; ctx.fillText('ç»™ç³–è±†æ‰¾ä¸€ä¸ªå°ç©ä¼´', 50, 90);
      // å›¾ç‰‡
      const img=new Image(); img.crossOrigin='anonymous'; img.src='../assets/rabbit.jpg';
      await new Promise(r=>{ img.onload=r; img.onerror=r; });
      const ph=720, pw=600; // æ¡†
      const ratio=Math.min(pw/img.width, ph/img.height);
      const iw=img.width*ratio, ih=img.height*ratio;
      const ix= (W-pw)/2 + (pw-iw)/2, iy=170+(ph-ih)/2;
      ctx.fillStyle='#fff'; ctx.roundRect?.( (W-pw)/2, 170, pw, ph, 24) || ctx.fillRect((W-pw)/2,170,pw,ph);
      ctx.drawImage(img, ix, iy, iw, ih);
      // æ–‡æ¡ˆ
      ctx.fillStyle='#6b5835'; ctx.font='24px system-ui';
      const ts=new Date(); const t = ts.getFullYear()+'-'+String(ts.getMonth()+1).padStart(2,'0')+'-'+String(ts.getDate()).padStart(2,'0');
      ctx.fillText('æ”¶é›†äºï¼š'+t, 50, 950);
      // ä¸‹è½½
      const a=document.createElement('a'); a.download='little-friend.png'; a.href=cvs.toDataURL('image/png'); a.click();
    }
    return { save };
  })();

  ;const SpinWheel=(function(){
    const wheel=document.getElementById('wheel'), btn=document.getElementById('spinBtn'), chanceEl=document.getElementById('chanceText');
    // äº”æ‰‡åŒºï¼ˆé¡ºæ—¶é’ˆï¼‰ï¼šå†æ¥ä¸€æ¬¡ã€ä¸€æ¯å¥¶èŒ¶ã€å°çŒ«ç©å¶ã€å¯¹æˆ‘è¯´ï¼šæˆ‘å¥½å¼€å¿ƒï¼ã€ç»™ç³–è±†æ‰¾ä¸€ä¸ªå°ç©ä¼´
    const sectors=['å†æ¥ä¸€æ¬¡','ä¸€æ¯å¥¶èŒ¶','å°çŒ«ç©å¶','å¯¹æˆ‘è¯´ï¼šæˆ‘å¥½å¼€å¿ƒï¼','ç»™ç³–è±†æ‰¾ä¸€ä¸ªå°ç©ä¼´'];
    const colors=['#ffe0ea','#fde6c9','#e9f4d6','#e2f0ff','#f6e3ff'];
    // ç”»ç›˜
    const step=360/sectors.length;
    sectors.forEach((name,i)=>{
      const s=document.createElement('div'); s.className='sector';
      s.style.transform=`translate(-50%,-100%) rotate(${i*step}deg) skewY(${90-step}deg)`;
      s.style.background=colors[i%colors.length];
      const lab=document.createElement('div'); lab.className='label';
      lab.style.transform=`translate(-50%,-50%) rotate(${step/2}deg)`; lab.textContent=name; s.appendChild(lab);
      wheel.appendChild(s);
    });

    // æ¬¡æ•°ä¸ rig
    let spins = Storage.get('bc_spin_count', 0); // 0,1,2
    updateChance();
    if(spins>=2) btn.disabled=true;

    function updateChance(){ chanceEl.textContent = 'å‰©ä½™æ¬¡æ•°ï¼š' + Math.max(0, 2 - spins); }

    function rigTarget(){
      if(spins===0) return sectors.indexOf('ç»™ç³–è±†æ‰¾ä¸€ä¸ªå°ç©ä¼´');
      if(spins===1) return sectors.indexOf('å¯¹æˆ‘è¯´ï¼šæˆ‘å¥½å¼€å¿ƒï¼');
      // ä¸ä¼šèµ°åˆ°ï¼ˆæœ€å¤šä¸¤æ¬¡ï¼‰ï¼›ç•™ä½œå…œåº•
      return Math.floor(Math.random()*sectors.length);
    }
    function spin(){
      if(spins>=2) return;
      btn.disabled=true;
      const idx = rigTarget();
      const step=360/sectors.length;
      const endDeg = 360*5 + (idx*step + step/2); // å¤šè½¬å‡ åœˆå†è½ä¸­çº¿
      wheel.style.transform = `rotate(${endDeg}deg)`;
      wheel.style.transition = 'transform 4s cubic-bezier(.17,.89,.32,1.27)';
      setTimeout(()=>{
        spins++; Storage.set('bc_spin_count', spins); updateChance();
        const prize = sectors[idx];
        PrizePanel.set(prize);

        // ç‰¹æ®Šå¥–é¡¹
        if(prize==='ç»™ç³–è±†æ‰¾ä¸€ä¸ªå°ç©ä¼´'){
          Storage.set('bc_partner_got', true);
          document.getElementById('overlay').classList.add('show');
        }
        if(spins>=2) btn.disabled=true; else btn.disabled=false;
      }, 4100);
    }
    btn.addEventListener('click', spin);
    return {};
  })();

  // å¼¹å±‚äº‹ä»¶
  (function(){
    document.getElementById('closeModal').addEventListener('click',()=>document.getElementById('overlay').classList.remove('show'));
    document.getElementById('saveCard').addEventListener('click', SaveCard.save);
  })();
  </script>
</body>
</html>

