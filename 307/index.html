<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>ğŸ å½©è›‹æˆ¿é—´</title>
<style>
  :root{--pink:#ff5c8a;--tea:#d4b073;--muted:#7a7a7a}
  html,body{margin:0}
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#fff9f3,#fff);color:#222}
  .wrap{max-width:860px;margin:0 auto;padding:22px}
  .card{background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:22px;margin-bottom:16px}
  h1{margin:8px 0 6px;font-weight:700}
  .center{text-align:center}
  .btn{padding:12px 16px;border-radius:999px;background:var(--pink);color:#fff;border:none;font-weight:700}
  .btn:active{transform:scale(.95)}
  .muted{color:var(--muted)} .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

  /* é•¿æŒ‰è¿›åº¦ç¯ */
  .hold{display:flex;flex-direction:column;align-items:center;gap:10px}
  .ring{width:80px;height:80px;border-radius:50%;background:
    conic-gradient(var(--pink) 0deg, #ffd3e1 0deg);
    display:grid;place-items:center}
  .ring span{background:#fff9f3;border-radius:50%;width:62px;height:62px;display:grid;place-items:center;font-weight:700}
  .hidden{display:none}

  /* è½¬ç›˜ */
  .wheelWrap{display:grid;place-items:center}
  .wheel{width:min(90vw,340px);height:min(90vw,340px);border-radius:50%;border:10px solid #f2e4c8;position:relative;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  .slice{position:absolute;inset:0;clip-path:polygon(50% 50%, 0 0, 100% 0);display:flex;align-items:flex-start;justify-content:center;padding-top:24px;font-weight:700}
  .slice:nth-child(1){transform:rotate(0deg);background:#ffe5ec}
  .slice:nth-child(2){transform:rotate(60deg);background:#fff3d6}
  .slice:nth-child(3){transform:rotate(120deg);background:#e7f7f1}
  .slice:nth-child(4){transform:rotate(180deg);background:#ffe5ec}
  .slice:nth-child(5){transform:rotate(240deg);background:#fff3d6}
  .slice:nth-child(6){transform:rotate(300deg);background:#e7f7f1}
  .pointer{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:24px solid var(--tea);margin:10px auto}
  .spinBtn{margin-top:10px}
  .disabled{opacity:.5;pointer-events:none}

  /* ç»“æœå¼¹å±‚ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .inner{background:#fff;border-radius:18px;max-width:480px;width:100%;padding:20px;text-align:center}
  .inner img{max-width:100%;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.12)}
</style>

<div class="wrap">
  <div class="card center">
    <div class="pointer"></div>
    <h1>å½©è›‹æˆ¿é—´ ğŸˆ</h1>

    <!-- é•¿æŒ‰è§£é”ï¼ˆå¸¦è¿›åº¦ç¯ï¼‰ -->
    <div id="locker" class="hold">
      <div class="ring" id="ring"><span id="ringText">2.0</span></div>
      <button class="btn" id="holdBtn">æŒ‰ä½ 2 ç§’è§£é”</button>
      <div class="muted">ï¼ˆæ¾æ‰‹ä¼šä¸­æ–­å“¦ï¼‰</div>
    </div>

    <!-- è§£é”åçš„è½¬ç›˜ -->
    <div id="wheelArea" class="wheelWrap hidden">
      <div class="wheel" id="wheel">
        <div class="slice">å†è½¬ä¸€æ¬¡</div>
        <div class="slice">å¥¶èŒ¶ä¸€æ¯</div>
        <div class="slice">æ‹¥æŠ±åç§’</div>
        <div class="slice">å†è½¬ä¸€æ¬¡</div>
        <div class="slice">ç”œç‚¹ä¸€ä»½</div>
        <div class="slice">ç”µå½±ä¸€åœº</div>
      </div>
      <div class="row">
        <button class="btn spinBtn" id="spinBtn">å¼€å§‹è½¬</button>
      </div>
      <div class="muted">ç‰¹ç­‰å¥–éšè—ï¼šä¸€åªå°å…”å­ / ä¸€åªå°çŒ«</div>
    </div>
  </div>
</div>

<!-- â€œè·å¾—ä¸€åªå°å…”å­â€å¼¹å±‚ -->
<div class="modal" id="rabbitModal">
  <div class="inner">
    <h2>è·å¾—ä¸€åªå°å…”å­ ğŸ°</h2>
    <img id="rabbitImg" src="" alt="å°å…”å­">
    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveBtn">ä¿å­˜è¿™å¼ å¡ç‰‡</button>
      <button class="btn" id="closeRabbit">å¥½è€¶</button>
    </div>
    <div class="muted" style="margin-top:6px">ï¼ˆé•¿æŒ‰å›¾ç‰‡ä¹Ÿå¯ä¿å­˜ï¼‰</div>
  </div>
</div>

<script>
  /* ===== é…ç½®ï¼šå…”å­ç…§ç‰‡ & å¯é€‰ä¸ŠæŠ¥ ===== */
  const RABBIT_PHOTO_URL = "../assets/rabbit.jpg"; // æŠŠä½ çš„å…”å­å›¾ä¼ åˆ° assets/rabbit.jpg
  const WEBHOOK_URL = ""; // éœ€è¦æ—¶å¡«ä½ çš„ Webhookï¼ˆFormspree / Apps Script ç­‰ï¼‰

  const KEY_UNLOCKED = "bc_locker_unlocked";
  const KEY_SPIN_COUNT = "bc_spin_count";
  const KEY_RABBIT_GOT = "bc_rabbit_got";

  /* ===== é•¿æŒ‰è§£é”ï¼ˆ2 ç§’ + è¿›åº¦ç¯ï¼‰ ===== */
  const locker = document.getElementById("locker");
  const wheelArea = document.getElementById("wheelArea");
  const holdBtn = document.getElementById("holdBtn");
  const ring = document.getElementById("ring");
  const ringText = document.getElementById("ringText");

  function showWheel(){
    locker.classList.add("hidden");
    wheelArea.classList.remove("hidden");
  }

  // å·²è§£é”ç›´æ¥æ˜¾ç¤º
  if(localStorage.getItem(KEY_UNLOCKED)) showWheel();

  let t=null, start=0, need=2000;
  function updateRing(){
    const elapsed = Date.now()-start;
    const pct = Math.min(elapsed/need, 1);
    const deg = Math.round(pct*360);
    ring.style.background = `conic-gradient(var(--pink) ${deg}deg, #ffd3e1 0deg)`;
    ringText.textContent = ( (need-elapsed)/1000 ).toFixed(1);
  }
  function startHold(){
    start = Date.now();
    updateRing();
    t = setInterval(()=>{
      updateRing();
      if(Date.now()-start >= need){
        clearInterval(t); ringText.textContent="0.0";
        if(navigator.vibrate) navigator.vibrate(40);
        localStorage.setItem(KEY_UNLOCKED,"1");
        showWheel();
      }
    }, 50);
  }
  function cancelHold(){ clearInterval(t); ring.style.background=`conic-gradient(var(--pink) 0deg, #ffd3e1 0deg)`; ringText.textContent="2.0"; }
  ["mousedown","touchstart"].forEach(ev=> holdBtn.addEventListener(ev, startHold));
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(ev=> holdBtn.addEventListener(ev, cancelHold));

  /* ===== è½¬ç›˜ï¼ˆç¬¬ä¸€æ¬¡ï¼šå†è½¬ä¸€æ¬¡ï¼›ç¬¬äºŒæ¬¡ï¼šå°å…”å­ï¼›ä¹‹åç¦ç”¨ï¼‰ ===== */
  const wheel = document.getElementById("wheel");
  const spinBtn = document.getElementById("spinBtn");
  const rabbitModal = document.getElementById("rabbitModal");
  const rabbitImg = document.getElementById("rabbitImg");
  const closeRabbit = document.getElementById("closeRabbit");
  const saveBtn = document.getElementById("saveBtn");

  // å¦‚æœå·²ç»æ‹¿è¿‡å…”å­ï¼Œç›´æ¥ç¦ç”¨
  if(localStorage.getItem(KEY_RABBIT_GOT)){
    spinBtn.classList.add("disabled"); spinBtn.textContent="å·²è·å¾—å°å…”å­";
  }

  function spinTo(angle, cb){
    wheel.style.transition="transform 2.2s cubic-bezier(.18,.8,.2,1)";
    wheel.style.transform=`rotate(${angle}deg)`;
    wheel.addEventListener("transitionend", function h(){ wheel.removeEventListener("transitionend", h); cb && cb(); }, {once:true});
  }

  function report(payload){
    if(!WEBHOOK_URL) return;
    try{ fetch(WEBHOOK_URL,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }catch{}
  }

  spinBtn.addEventListener("click", ()=>{
    let count = parseInt(localStorage.getItem(KEY_SPIN_COUNT) || "0", 10);

    if(localStorage.getItem(KEY_RABBIT_GOT)){
      spinBtn.classList.add("disabled"); return;
    }

    // æŒ‡é’ˆåœ¨é¡¶éƒ¨ï¼ˆ0degï¼‰ï¼Œæˆ‘ä»¬è®©è½®ç›˜æ—‹è½¬åˆ°ç›®æ ‡æ‰‡åŒºä¸­å¿ƒï¼š
    // æ‰‡åŒº 6 ä¸ªï¼Œæ¯ä¸ª 60 åº¦ã€‚æˆ‘ä»¬è®¾å®šï¼š
    // ç¬¬ä¸€æ¬¡ -> â€œå†è½¬ä¸€æ¬¡â€ï¼ˆåœ¨ slice1 æˆ– slice4ï¼Œä»»é€‰å…¶ä¸€ï¼Œè¿™é‡Œå– slice1 ä¸­å¿ƒ 30degï¼‰
    // ç¬¬äºŒæ¬¡ -> â€œä¸€åªå°å…”å­ï¼ˆéšè—å¥–ï¼‰â€ -> è™½ä¸åœ¨ UI æ–‡æ¡ˆä¸­ï¼Œä½†æˆ‘ä»¬è½¬åˆ°æŸå›ºå®šè§’åº¦åç›´æ¥è§¦å‘å…”å­å¼¹å±‚
    // ä¸ºäº†è§†è§‰ç»Ÿä¸€ï¼Œç¬¬ä¸€æ¬¡è½¬å¤šåœˆ + 30 åº¦ï¼›ç¬¬äºŒæ¬¡è½¬å¤šåœˆ + 15 åº¦ï¼ˆçœ‹èµ·æ¥â€œæŒ‡åˆ°éšè—å¥–â€ï¼‰
    const base = 360*4; // å¤šè½¬å‡ åœˆå¥½çœ‹
    if(count===0){
      spinTo(base + 30, ()=>{
        alert("å†è½¬ä¸€æ¬¡ï½");
        localStorage.setItem(KEY_SPIN_COUNT, "1");
      });
    }else if(count===1){
      spinTo(base + 15, ()=>{
        // è§¦å‘å°å…”å­
        localStorage.setItem(KEY_RABBIT_GOT, "1");
        localStorage.setItem(KEY_SPIN_COUNT, "2");
        showRabbit();
        report({type:"rabbit_got", ts:Date.now(), ua:navigator.userAgent});
        spinBtn.classList.add("disabled"); spinBtn.textContent="å·²è·å¾—å°å…”å­";
      });
    }else{
      spinBtn.classList.add("disabled");
    }
  });

  function showRabbit(){
    rabbitImg.src = RABBIT_PHOTO_URL;
    rabbitModal.classList.add("show");
    if(navigator.vibrate) navigator.vibrate(40);
  }
  rabbitModal.addEventListener("click", e=>{ if(e.target.id==="rabbitModal") rabbitModal.classList.remove("show"); });
  closeRabbit.addEventListener("click", ()=> rabbitModal.classList.remove("show"));

  // ä¿å­˜å¡ç‰‡ï¼šæŠŠâ€œè·å¾—ä¸€åªå°å…”å­â€+ ç…§ç‰‡åˆæˆ PNG
  saveBtn.addEventListener("click", async ()=>{
    const img = new Image(); img.crossOrigin="anonymous"; img.src=RABBIT_PHOTO_URL; await img.decode();
    const w = 900, h = 1100; const c = document.createElement("canvas"); c.width=w; c.height=h; const ctx=c.getContext("2d");
    // èƒŒæ™¯
    const grad = ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0,"#fff9f3"); grad.addColorStop(1,"#ffffff"); ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
    // æ ‡é¢˜
    ctx.fillStyle="#222"; ctx.font="bold 44px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial"; ctx.fillText("è·å¾—ä¸€åªå°å…”å­", 70, 90);
    // å›¾ç‰‡è‡ªé€‚åº”
    const maxW=w-140, maxH=h-320; let iw=img.width, ih=img.height; const r=Math.min(maxW/iw, maxH/ih); iw*=r; ih*=r;
    ctx.fillStyle="#fff"; ctx.roundRect(70,120,iw+20,ih+20,18); ctx.fill(); // èƒŒæ™¯æ¡†
    ctx.drawImage(img, 80,130,iw,ih);
    // è¯´æ˜æ–‡å­—
    ctx.fillStyle="#7a7a7a"; ctx.font="20px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial";
    const d=new Date(); const t=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}  ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    ctx.fillText(`é¢†å–è€…ï¼šä½ çš„å°å¯çˆ±   æ—¶é—´ï¼š${t}`, 70, h-80);
    // ä¸‹è½½
    const a=document.createElement("a"); a.download="è·å¾—ä¸€åªå°å…”å­.png"; a.href=c.toDataURL("image/png"); a.click();
  });

  // å…¼å®¹ roundRect
  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){ if(typeof r!=="number") r=8; this.beginPath(); this.moveTo(x+r,y); this.arcTo(x+w,y,x+w,y+h,r); this.arcTo(x+w,y+h,x,y+h,r); this.arcTo(x,y+h,x,y,r); this.arcTo(x,y,x+w,y,r); this.closePath(); return this; }
  }
</script>
</html>


